<unit-shader-set name="mat_colour">

	<description>
		<![CDATA[
			A shader set for testing, using per-vertex lighting and material colour only (no textures).
		]]>
	</description>

	<glsl-version value="110" />

	<!-- varying and uniform vars -->
	<variables>
		<![CDATA[
		
			varying float      fogFactor, meshAlpha;
			varying vec3       lightColour;

			uniform float      gae_AlphaThreshold;
			uniform int        gae_IsUsingFog;			
			uniform vec3       gae_TeamColour;
			uniform sampler2D  gae_DiffuseTexture;
			
		]]>
	</variables>

	<vertex-shader>
		<![CDATA[
			void main() {
				// pass-on tex-coord & mesh colour
				gl_TexCoord[0] = gl_MultiTexCoord0;
				gl_FrontColor = gl_Color;
				meshAlpha = gl_Color.a;

				// Lighting
				vec3 normal = normalize(gl_NormalMatrix * gl_Normal);        // convert normal to eye space
				//vec3 lightDir = normalize(gl_NormalMatrix * vec3(10.0, 10.0, 10.0));
				vec3 lightDir = normalize(vec3(gl_LightSource[0].position)); // direction of main light source
				
				float diffuseIntensity = max(dot(lightDir, normal), 0.0);         // calculate diffuse term

				vec3 diffuse = gl_FrontLightProduct[0].diffuse.rgb * diffuseIntensity;
				vec3 ambient = gl_FrontLightProduct[0].ambient.rgb + gl_FrontLightModelProduct.sceneColor.rgb;
				
				lightColour = diffuse + ambient;

				// fog
				if (gae_IsUsingFog == 1) {
					float dist = length(vec3(gl_ModelViewMatrix * gl_Vertex)); // distance from camera
					const float log_2 = 1.442695;
					fogFactor = exp2(-gl_Fog.density * gl_Fog.density * dist * dist * log_2);
					fogFactor = clamp(fogFactor, 0.0, 1.0);	
				} else {
					fogFactor = 1.f;
				}
				// determine pixel position
				gl_Position = gl_ModelViewProjectionMatrix * gl_Vertex;
			}
		]]>
	</vertex-shader>	

	<team-fragment-shader>
		<![CDATA[
			void main() {				
				// final colour 
				vec4 finalColour = vec4(lightColour, meshAlpha);
				gl_FragColor = mix(gl_Fog.color, finalColour, fogFactor);
			}
		]]>
	</team-fragment-shader>

	<rgba-fragment-shader>
		<![CDATA[
			void main() {
				vec4 tex = texture2D(gae_DiffuseTexture, vec2(gl_TexCoord[0].st));
				if (tex.a < 0.5) {
					discard;
				}
				// final colour 
				vec4 finalColour = vec4(lightColour, tex.a * meshAlpha);
				gl_FragColor = mix(gl_Fog.color, finalColour, fogFactor);
			}
		]]>
	</rgba-fragment-shader>

</unit-shader-set>
